<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æƒ…ç·’è¡¨é”ç·´ç¿’å¡ - å°ˆæ³¨ç·´ç¿’</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ä½¿ç”¨ Inter å­—é«”ä»¥ç¢ºä¿è‰¯å¥½çš„å¯è®€æ€§ï¼Œä¸¦è¨­ç½®èƒŒæ™¯è‰² */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            touch-action: manipulation; /* å¢å¼·è§¸æ§éŸ¿æ‡‰ */
        }
        /* è®“æŒ‰éˆ•åœ¨è¢«é»æ“Šæ™‚æœ‰æ˜é¡¯å›é¥‹ */
        .emotion-btn:active, .coping-btn:active, .draw-card-btn:active {
            transform: scale(0.98);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -2px rgba(0, 0, 0, 0.2);
        }
        /* ç‚ºä¸»è¦å€å¡ŠåŠ ä¸Šé™°å½±å’Œåœ“è§’ */
        .card-container {
            min-height: 400px;
        }
        .emotion-icon {
            font-size: 4rem; /* æ”¾å¤§æƒ…ç·’åœ–ç¤º */
            line-height: 1; 
        }
        .coping-icon {
            font-size: 2.5rem; /* æ”¾å¤§è™•ç†æ–¹æ³•åœ–ç¤º */
            line-height: 1;
        }
        .text-huge {
            font-size: 2.75rem; /* æ¨™é¡Œæ–‡å­— */
            font-weight: 800;
        }
        /* è™•ç†æ–¹æ³•æŒ‰éˆ•å…§éƒ¨çš„åœ–ç‰‡æ¨£å¼ */
        .coping-btn img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            /* è®“åœ–ç‰‡åœ¨è¼‰å…¥æ™‚æœ‰ä¸€å€‹åŸºæœ¬èƒŒæ™¯ï¼Œé¿å…é–ƒçˆ */
            background-color: rgba(0, 0, 0, 0.1); 
        }
        /* è¼‰å…¥å‹•ç•« */
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
        .loading-spinner {
          border: 4px solid rgba(255, 255, 255, 0.3);
          border-top: 4px solid #fff;
          border-radius: 50%;
          width: 40px;
          height: 40px;
          animation: spin 1s linear infinite;
        }
        .image-loading {
            position: relative;
        }
        .image-loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        /* æ’²å…‹ç‰ŒæŒ‰éˆ•æ¨£å¼ */
        .draw-card-style {
            background-color: #B91C1C; /* Red 700 */
            border-bottom: 8px solid #7F1D1D; /* Red 900 for 3D effect */
            transition: all 0.15s ease-in-out;
        }
        .draw-card-style:hover {
            background-color: #DC2626; /* Red 600 */
            transform: scale(1.05);
        }
        .draw-card-style:active {
            border-bottom: 2px solid #7F1D1D;
            transform: translateY(4px);
        }
    </style>
</head>
<body class="p-4 sm:p-8 flex flex-col items-center min-h-screen">

    <header class="w-full max-w-4xl text-center mb-6">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-blue-700">å¿ƒæƒ…ç·´ç¿’å°å¹«æ‰‹</h1>
        <p class="text-gray-600 mt-2 text-lg sm:text-xl">éš¨æ©ŸæŠ½ç‰Œï¼Œç·´ç¿’è¡¨é”å¿ƒæƒ…èˆ‡è™•ç†æƒ…ç·’çš„æ–¹æ³•</p>
    </header>

    <main class="w-full max-w-4xl bg-white p-6 sm:p-10 rounded-3xl shadow-2xl card-container flex flex-col items-center">

        <!-- ç•«é¢å…§å®¹å€ -->
        <div id="app-content" class="w-full text-center">

            <!-- éšæ®µ 0: æŠ½ç‰Œé–‹å§‹ç•«é¢ (æ’²å…‹ç‰ŒæŒ‰éˆ•) -->
            <div id="phase-0" class="flex flex-col items-center justify-center h-full space-y-8">
                <p class="text-huge text-indigo-600 mb-8">æº–å‚™å¥½äº†å—ï¼Ÿ</p>
                <!-- æ’²å…‹ç‰Œé¢¨æ ¼æŒ‰éˆ• -->
                <button onclick="drawCard()" class="draw-card-btn draw-card-style text-white text-4xl font-extrabold py-6 px-12 rounded-2xl shadow-2xl">
                    <span class="text-6xl align-middle">ğŸƒ</span> 
                    <span class="block mt-2">æŠ½ä¸€å¼µæƒ…å¢ƒå¡ï¼</span>
                </button>
                <p class="text-gray-500 text-base mt-4">é»æ“Šä¸Šæ–¹å¤§æŒ‰éˆ•é–‹å§‹ç·´ç¿’</p>
            </div>

            <!-- éšæ®µ 1: æƒ…å¢ƒå±•ç¤ºèˆ‡å¿ƒæƒ…é¸æ“‡ -->
            <div id="phase-1" class="hidden space-y-6">
                <p class="text-xl sm:text-2xl font-semibold text-gray-700">ç¬¬ 1 æ­¥ï¼šç™¼ç”Ÿäº†ä»€éº¼äº‹ï¼Ÿ</p>
                
                <!-- æƒ…å¢ƒå¡å€åŸŸï¼šæ–°å¢åœ–ç‰‡å€å¡Š -->
                <div class="bg-yellow-100 border-4 border-yellow-500 p-6 sm:p-8 rounded-2xl flex flex-col items-center space-y-4">
                    <div class="flex items-center space-x-4">
                        <span class="text-6xl" role="img" aria-label="æƒ…å¢ƒ">ğŸ’¡</span>
                        <p class="text-huge text-yellow-800" id="scenario-text"></p>
                    </div>
                    
                    <!-- åœ–ç‰‡é¡¯ç¤ºå€ï¼šé è¨­ç‚ºä½”ä½ç¬¦ï¼Œå¯è¢« AI ç”Ÿæˆåœ–ç‰‡æ›¿æ› -->
                    <div id="image-container" class="w-full max-w-sm h-auto mt-4 flex flex-col items-center">
                        <img id="scenario-image" src="" alt="æƒ…å¢ƒæ¨¡æ“¬åœ–ç‰‡" class="w-full rounded-lg shadow-lg border-2 border-yellow-500" 
                            onerror="this.onerror=null; this.src='https://placehold.co/400x200/AAAAAA/FFFFFF?text=åœ–ç‰‡è¼‰å…¥å¤±æ•—+Load+Failed';" style="max-height: 200px; object-fit: cover;">
                        
                        <!-- AI ç”ŸæˆæŒ‰éˆ• -->
                        <button id="generate-image-btn" onclick="generateScenarioImage()" class="mt-4 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out text-sm flex items-center space-x-2">
                            <span class="text-xl">ğŸ¨</span>
                            <span>AI ç”Ÿæˆæƒ…å¢ƒåœ–</span>
                        </button>
                        <div id="loading-indicator" class="hidden mt-4 bg-indigo-500 text-white py-2 px-4 rounded-lg shadow-md flex items-center space-x-2">
                            <div class="loading-spinner"></div>
                            <span>åœ–ç‰‡ç”Ÿæˆä¸­...</span>
                        </div>
                    </div>
                </div>

                <p class="text-xl sm:text-2xl font-semibold text-gray-700 mt-8">ç¬¬ 2 æ­¥ï¼šä½ æœƒæœ‰ä»€éº¼æ¨£çš„å¿ƒæƒ…å‘¢ï¼Ÿ</p>
                <div id="emotion-selection" class="grid grid-cols-2 gap-4 sm:grid-cols-4 sm:gap-6">
                    <!-- æƒ…ç·’æŒ‰éˆ•å°‡ç”± JS å‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>

            <!-- éšæ®µ 2: è™•ç†æƒ…ç·’çš„æ–¹æ³•é¸æ“‡ -->
            <div id="phase-2" class="hidden space-y-6">
                <p class="text-huge text-green-700" id="selected-emotion-text"></p>
                <p class="text-xl sm:text-2xl font-semibold text-gray-700 mt-4">ç¬¬ 3 æ­¥ï¼šæ€éº¼è®“å¿ƒæƒ…è®Šå¥½/å¹³éœä¸‹ä¾†å‘¢ï¼Ÿ</p>
                <div id="coping-selection" class="grid grid-cols-1 gap-4 sm:grid-cols-3 sm:gap-6">
                    <!-- è™•ç†æ–¹æ³•æŒ‰éˆ•å°‡ç”± JS å‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>

            <!-- éšæ®µ 3: å®Œæˆèˆ‡å›é¥‹ (åŠ å…¥æŠ½ä¸‹ä¸€å¼µå¡çš„æŒ‰éˆ•) -->
            <div id="phase-3" class="hidden flex flex-col items-center justify-center space-y-8">
                <div class="emotion-icon animate-bounce text-6xl">ğŸ‰</div> <!-- æ”¹è®Šç‚ºæ…¶ç¥åœ–ç¤º -->
                <p class="text-huge text-teal-600">åšå¾—å¤ªæ£’äº†ï¼</p>
                <p class="text-xl sm:text-2xl font-semibold text-gray-700">ä½ å­¸æœƒäº†è¡¨é”å¿ƒæƒ…å’Œè™•ç†æ–¹æ³•ï¼</p>
                <!-- æŠ½ä¸‹ä¸€å¼µå¡æŒ‰éˆ•ï¼Œä½¿ç”¨å’Œ Phase 0 ç›¸ä¼¼çš„è¨­è¨ˆ -->
                <button onclick="resetApp()" class="draw-card-btn draw-card-style text-white text-3xl font-bold py-4 px-8 rounded-2xl shadow-xl">
                    <span class="text-4xl align-middle">ğŸƒ</span> 
                    <span class="block mt-1">å†æŠ½ä¸€å¼µæƒ…å¢ƒå¡ï¼</span>
                </button>
            </div>

        </div>

    </main>

    <footer class="mt-8 text-center text-sm text-gray-400">
        æƒ…ç·’ç·´ç¿’å°å·¥å…· | è¨­è¨ˆçµ¦è¡¨é”ç·´ç¿’ä½¿ç”¨
    </footer>

    <script type="text/javascript">
        // --- æ‡‰ç”¨ç¨‹å¼è³‡æ–™èˆ‡ç‹€æ…‹ ---
        const emotions = {
            'HAPPY': {
                name: 'é«˜èˆˆ ğŸ˜„',
                color: 'bg-green-500 hover:bg-green-600',
                methods: [
                    // è‚¢é«”å¾®å‹•æˆ–éœæ…‹æ´»å‹•
                    { icon: 'ğŸ—£ï¸', text: 'èªªå‡ºä¾†/è«‹è€å¸«è½', imageUrl: 'https://placehold.co/100x100/3CB371/FFFFFF?text=èªªå‡ºä¾†', aiPrompt: 'A simple, cute cartoon illustration of a child speaking or communicating with a teacher, happy expression. Flat design style.' }, 
                    { icon: 'ğŸ¤©', text: 'å°ˆå¿ƒçœ‹å–œæ­¡çš„å½±ç‰‡', imageUrl: 'https://placehold.co/100x100/3CB371/FFFFFF?text=çœ‹å½±ç‰‡', aiPrompt: 'A simple cartoon of a child watching a tablet or TV screen with a focused, happy expression. Bright colors.' }, 
                    { icon: 'âœ‹', text: 'æ‹æ‰‹/åšå–œæ­¡çš„å¾®å‹•', imageUrl: 'https://placehold.co/100x100/3CB371/FFFFFF?text=æ‹æ‰‹', aiPrompt: 'A close-up of two small hands clapping gently, simple cartoon style.' }, 
                ],
                bgClass: 'bg-green-200'
            },
            'SAD': {
                name: 'é›£é ğŸ˜¢',
                color: 'bg-blue-500 hover:bg-blue-600',
                methods: [
                    // éœæ…‹æ´»å‹•
                    { icon: 'ğŸ§¸', text: 'æŠ±æŠ±å¨ƒå¨ƒ/æŠ±æ•', imageUrl: 'https://placehold.co/100x100/4169E1/FFFFFF?text=æŠ±å¨ƒå¨ƒ', aiPrompt: 'A child hugging a large, soft teddy bear while sitting down, simple and comforting cartoon style.' }, 
                    { icon: 'ğŸ§', text: 'è½è¼•é¬†çš„éŸ³æ¨‚', imageUrl: 'https://placehold.co/100x100/4169E1/FFFFFF?text=è½éŸ³æ¨‚', aiPrompt: 'A simple cartoon of a child sitting quietly with headphones on, listening to music. Relaxing and soft colors.' }, 
                    { icon: 'ğŸ’¤', text: 'è“‹æ¯¯å­ä¼‘æ¯ä¸€ä¸‹', imageUrl: 'https://placehold.co/100x100/4169E1/FFFFFF?text=ä¼‘æ¯', aiPrompt: 'A child covered in a soft blanket, resting with eyes closed. Calm and peaceful cartoon illustration.' }, 
                ],
                bgClass: 'bg-blue-200'
            },
            'GRIEF': {
                name: 'æ‚²å‚· ğŸ˜­',
                color: 'bg-purple-500 hover:bg-purple-600',
                methods: [
                    // éœæ…‹æ´»å‹•æˆ–æ±‚åŠ©
                    { icon: 'ğŸ˜¢', text: 'å“­å‡ºä¾†/è®“çœ¼æ·šæµ', imageUrl: 'https://placehold.co/100x100/8A2BE2/FFFFFF?text=å“­æ³£', aiPrompt: 'A simple cartoon drawing of a child with tears flowing down, expressive and sad. Sympathetic mood.' }, 
                    { icon: 'ğŸ§˜', text: 'èººå¹³ä¼‘æ¯/é–‰ä¸Šçœ¼ç›', imageUrl: 'https://placehold.co/100x100/8A2BE2/FFFFFF?text=èººè‘—', aiPrompt: 'A peaceful, simple cartoon illustration of a child lying down with closed eyes, focusing on stillness.' }, 
                    { icon: 'ğŸ“', text: 'æŒ‰éˆ´/å‘¼å«å”åŠ©', imageUrl: 'https://placehold.co/100x100/8A2BE2/FFFFFF?text=å‘¼å«', aiPrompt: 'A cartoon image of a large, easy-to-press call button or bell being reached for by a hand. Clear communication focus.' }, 
                ],
                bgClass: 'bg-purple-200'
            },
            'ANGRY': {
                name: 'ç”Ÿæ°£ ğŸ˜¡',
                color: 'bg-red-500 hover:bg-red-600',
                methods: [
                    // éœæ…‹æ´»å‹•
                    { icon: 'ğŸ’¨', text: 'æ·±å‘¼å¸ 10 æ¬¡', imageUrl: 'https://placehold.co/100x100/FF4500/FFFFFF?text=æ·±å‘¼å¸', aiPrompt: 'A simple cartoon showing a child inhaling deeply, with big clear air movement lines. Focus on calming down.' }, 
                    { icon: 'ğŸ‘€', text: 'æ•¸æ•¸/çœ‹å–œæ­¡çš„æ±è¥¿', imageUrl: 'https://placehold.co/100x100/FF4500/FFFFFF?text=æ•¸æ•¸', aiPrompt: 'A child looking at a simple picture book or toy with focused eyes. Cartoon style.' }, 
                    { icon: 'ğŸ‘Š', text: 'æå£“åŠ›çƒæˆ–æŠ±æ•', imageUrl: 'https://placehold.co/100x100/FF4500/FFFFFF?text=ææŠ±æ•', aiPrompt: 'A close-up of a hand tightly squeezing a brightly colored stress ball or pillow. Simple illustration of tension release.' }, 
                ],
                bgClass: 'bg-red-200'
            }
        };

        const scenarios = [
            { text: 'ä½ åœ¨å­¸æ ¡å¾—åˆ°äº†ä¸€æœµå°ç´…èŠ±çå‹µ', correct: 'HAPPY', imageUrl: 'https://placehold.co/400x200/4CAF50/FFFFFF?text=å¾—åˆ°çå‹µ+Star', aiPrompt: 'A simple, bright, and colorful cartoon drawing of a smiling child in a wheelchair holding up a red flower sticker in a classroom setting. Cute style, clean lines.' },
            { text: 'ä½ æœ€å–œæ­¡çš„ç©å…·è¢«å¼Ÿå¼Ÿå¼„å£äº†', correct: 'ANGRY', imageUrl: 'https://placehold.co/400x200/FF5733/FFFFFF?text=ç©å…·å£æ‰+Broken+Toy', aiPrompt: 'A cartoon drawing of a broken toy block tower next to a child with an upset face. Vibrant colors, simple shapes.' },
            { text: 'åª½åª½ä»Šå¤©æ²’æœ‰çµ¦ä½ æœ€å–œæ­¡çš„é»å¿ƒ', correct: 'SAD', imageUrl: 'https://placehold.co/400x200/F0E68C/000000?text=æ²’æœ‰é»å¿ƒ+No+Snack', aiPrompt: 'A child looking sadly at an empty plate. Simple, soft cartoon style.' },
            { text: 'ä½ è·Œå€’äº†ï¼Œè†è“‹æœ‰ä¸€é»é»ç—›', correct: 'SAD', imageUrl: 'https://placehold.co/400x200/ADD8E6/000000?text=è·Œå€’å—å‚·+Fall+Hurt', aiPrompt: 'A cartoon child sitting down gently rubbing a knee, with a small tear in their eye. Soft colors, focused on comfort.' },
            { text: 'è€å¸«ç¨±è®šä½ ä»Šå¤©åœ¨èª²å ‚ä¸Šè¡¨ç¾å¾ˆæ£’', correct: 'HAPPY', imageUrl: 'https://placehold.co/400x200/87CEFA/FFFFFF?text=è€å¸«ç¨±è®š+Praise', aiPrompt: 'A bright cartoon image of a teacher giving a thumbs up to a child. Happy and positive mood.' },
            { text: 'å¥½æœ‹å‹æŠŠä½ çš„ç©æœ¨ä¸å°å¿ƒå¼„å€’äº†', correct: 'ANGRY', imageUrl: 'https://placehold.co/400x200/F08080/FFFFFF?text=ç©æœ¨å€’å¡Œ+Blocks+Tumble', aiPrompt: 'A cartoon image showing scattered blocks and a child making an angry face. Simple and direct illustration.' },
            { text: 'ä½ è½åˆ°ä¸€å€‹å¾ˆé›£éçš„æ¶ˆæ¯ï¼Œæƒ³å“­', correct: 'GRIEF', imageUrl: 'https://placehold.co/400x200/4682B4/FFFFFF?text=é›£éæƒ³å“­+Sad+Tear', aiPrompt: 'A cartoon child with a stream of tears, sitting down and looking very sad. Gentle, sympathetic colors.' },
            { text: 'å…¶ä»–å°æœ‹å‹ä»Šå¤©æ±ºå®šä¸è·Ÿä½ ä¸€èµ·ç©', correct: 'SAD', imageUrl: 'https://placehold.co/400x200/B0C4DE/000000?text=è¢«æ’æ“ +Excluded', aiPrompt: 'A cartoon image of a child looking away while two other children play, simple sad expression. Focus on soft sadness.' },
            { text: 'ä½ å®Œæˆäº†ä¸€å€‹å¾ˆé›£çš„ä»»å‹™ï¼Œè¦ºå¾—å¾ˆæœ‰æˆå°±æ„Ÿ', correct: 'HAPPY', imageUrl: 'https://placehold.co/400x200/20B2AA/FFFFFF?text=å®Œæˆä»»å‹™+Mission+Complete', aiPrompt: 'A victorious cartoon child raising their fist in the air next to a finished puzzle or project. Bright and celebratory.' },
            { text: 'ä½ æœ€æ„›çš„å°å‹•ç‰©ç”Ÿç—…äº†ï¼Œä½ å¾ˆæ“”å¿ƒ', correct: 'GRIEF', imageUrl: 'https://placehold.co/400x200/6A5ACD/FFFFFF?text=å¯µç‰©ç”Ÿç—…+Pet+Sick', aiPrompt: 'A simple cartoon drawing of a child gently petting a small, sad-looking puppy in a bed. Soft and caring mood.' },
            { text: 'å¤–é¢ä¸‹å¤§é›¨ï¼Œä¸èƒ½å‡ºå»ç©äº†', correct: 'SAD', imageUrl: 'https://placehold.co/400x200/A9A9A9/FFFFFF?text=ä¸‹é›¨äº†+Rain+Puddles', aiPrompt: 'A cartoon child looking out a window at heavy rain, simple expression of disappointment. Blue and grey tones.' },
            { text: 'ä½ åœ¨åœ°ä¸Šç™¼ç¾äº†ä¸€éš»å¯æ„›çš„å°è²“', correct: 'HAPPY', imageUrl: 'https://placehold.co/400x200/FFD700/000000?text=ç™¼ç¾å°è²“+Kitten+Find', aiPrompt: 'A joyful cartoon drawing of a child smiling at a small, curious kitten on the ground. Warm and happy colors.' },
            { text: 'æœ‰äººæ’éšŠï¼Œæ²’æœ‰éµå®ˆè¦å‰‡', correct: 'ANGRY', imageUrl: 'https://placehold.co/400x200/DC143C/FFFFFF?text=æœ‰äººæ’éšŠ+Cut+Line', aiPrompt: 'A cartoon illustration of a child with a frustrated face watching another child cut in line. Clear expression of unfairness.' },
            { text: 'ä½ å¼„ä¸Ÿäº†å°ä½ æœ‰æ„ç¾©çš„ç´€å¿µå“', correct: 'GRIEF', imageUrl: 'https://placehold.co/400x200/808080/FFFFFF?text=å¼„ä¸Ÿç´€å¿µå“+Lost+Memory', aiPrompt: 'A child looking sadly at an empty hand or pocket. Simple, melancholic cartoon style.' },
        ];

        let currentScenario = null;
        let selectedEmotionKey = null;
        // åœ–ç‰‡å¿«å–ï¼Œé¿å…é‡è¤‡ç”Ÿæˆ
        const imageCache = {}; 

        // --- DOM å…ƒç´ å¿«å– ---
        const phases = {
            0: document.getElementById('phase-0'),
            1: document.getElementById('phase-1'),
            2: document.getElementById('phase-2'),
            3: document.getElementById('phase-3')
        };
        const scenarioText = document.getElementById('scenario-text');
        const scenarioImage = document.getElementById('scenario-image'); 
        const generateImageBtn = document.getElementById('generate-image-btn');
        const loadingIndicator = document.getElementById('loading-indicator');
        const emotionSelectionDiv = document.getElementById('emotion-selection');
        const copingSelectionDiv = document.getElementById('coping-selection');
        const selectedEmotionText = document.getElementById('selected-emotion-text');
        const mainCard = document.querySelector('.card-container');


        // --- API ç›¸é—œå·¥å…·å‡½æ•¸ ---

        const apiKey = ""; 
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`;

        /** * å‘¼å« Imagen API ç”Ÿæˆåœ–ç‰‡ 
         * @param {string} prompt 
         * @param {string} aspectRatio 
         */
        async function callImageAPI(prompt, aspectRatio = "16:9") {
            const cacheKey = prompt + aspectRatio;
            if (imageCache[cacheKey]) {
                return imageCache[cacheKey];
            }

            const payload = { 
                instances: [{ prompt: prompt }], 
                parameters: { "sampleCount": 1, "aspectRatio": aspectRatio } 
            };
            
            // è™•ç†æŒ‡æ•¸é€€é¿
            const maxRetries = 3;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    
                    if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                        const base64Data = result.predictions[0].bytesBase64Encoded;
                        const imageUrl = `data:image/png;base64,${base64Data}`;
                        imageCache[cacheKey] = imageUrl; // å­˜å…¥å¿«å–
                        return imageUrl;
                    } else {
                        throw new Error('Image generation failed: No base64 data received.');
                    }
                } catch (error) {
                    console.error(`Attempt ${i + 1} failed:`, error);
                    if (i < maxRetries - 1) {
                        const delay = Math.pow(2, i) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        throw new Error('Image generation failed after multiple retries.');
                    }
                }
            }
        }

        /** è™•ç†æƒ…å¢ƒåœ–ç‰‡ç”Ÿæˆ */
        async function generateScenarioImage() {
            if (!currentScenario || !currentScenario.aiPrompt) {
                // ä½¿ç”¨è‡ªå®šç¾©è¨Šæ¯æ¡†ä»£æ›¿ alert
                const messageBox = document.createElement('div');
                messageBox.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center';
                messageBox.innerHTML = '<div class="bg-white p-6 rounded-lg shadow-xl text-center"><p class="font-bold text-red-500 mb-4">éŒ¯èª¤</p><p>è«‹å…ˆæŠ½å–æƒ…å¢ƒå¡ç‰‡ï¼</p><button onclick="this.parentNode.parentNode.remove()" class="mt-4 bg-red-500 text-white py-2 px-4 rounded">ç¢ºå®š</button></div>';
                document.body.appendChild(messageBox);
                return;
            }

            // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹ï¼Œéš±è—æŒ‰éˆ•
            generateImageBtn.classList.add('hidden');
            loadingIndicator.classList.remove('hidden');
            scenarioImage.src = 'https://placehold.co/400x200/94A3B8/FFFFFF?text=AI+ç”Ÿæˆä¸­...'; // è¼‰å…¥ä¸­çš„ä½”ä½åœ–

            try {
                // ä½¿ç”¨ 16:9 æ¯”ä¾‹ç”Ÿæˆæƒ…å¢ƒåœ–
                const imageUrl = await callImageAPI(currentScenario.aiPrompt, "16:9");
                scenarioImage.src = imageUrl;
            } catch (error) {
                console.error('Error generating image:', error);
                // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
                scenarioImage.src = 'https://placehold.co/400x200/EF4444/FFFFFF?text=AI+ç”Ÿæˆå¤±æ•—'; 
            } finally {
                // éš±è—è¼‰å…¥ç‹€æ…‹ï¼Œé¡¯ç¤ºæŒ‰éˆ•
                loadingIndicator.classList.add('hidden');
                generateImageBtn.classList.remove('hidden');
            }
        }


        // --- æ ¸å¿ƒé‚è¼¯å‡½æ•¸ ---

        /** é¡¯ç¤ºç‰¹å®šéšæ®µä¸¦éš±è—å…¶ä»– */
        function showPhase(phase) {
            Object.values(phases).forEach(el => el.classList.add('hidden'));
            phases[phase].classList.remove('hidden');
        }

        /** é‡ç½®æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹ä¸¦å›åˆ°åˆå§‹ç•«é¢ */
        function resetApp() {
            currentScenario = null;
            selectedEmotionKey = null;
            mainCard.classList.remove(...Object.values(emotions).map(e => e.bgClass));
            
            // é‡ç½®åœ–ç‰‡é¡¯ç¤ºç‚ºé è¨­ä½”ä½ç¬¦
            scenarioImage.src = ''; 
            generateImageBtn.classList.remove('hidden');
            loadingIndicator.classList.add('hidden');

            showPhase(0);
        }

        /** éš¨æ©ŸæŠ½ä¸€å¼µæƒ…å¢ƒå¡ */
        function drawCard() {
            // æ¸…é™¤ä¸Šæ¬¡ç”Ÿæˆçš„æƒ…å¢ƒåœ–å¿«å–
            scenarioImage.src = ''; 

            const randomIndex = Math.floor(Math.random() * scenarios.length);
            currentScenario = scenarios[randomIndex];

            scenarioText.textContent = currentScenario.text;
            scenarioImage.src = currentScenario.imageUrl; // éœæ…‹ä½”ä½åœ–ä½œç‚ºå›é€€
            generateImageBtn.classList.remove('hidden');
            loadingIndicator.classList.add('hidden');

            renderEmotionButtons();
            showPhase(1);
        }

        /** æ¸²æŸ“æƒ…ç·’é¸æ“‡æŒ‰éˆ• (åœ–ç¤ºå„ªå…ˆ) */
        function renderEmotionButtons() {
            emotionSelectionDiv.innerHTML = '';
            const emotionKeys = Object.keys(emotions).sort(() => Math.random() - 0.5);

            emotionKeys.forEach(key => {
                const emotion = emotions[key];
                const button = document.createElement('button');
                button.className = `emotion-btn ${emotion.color} text-white font-bold p-4 sm:p-6 rounded-xl shadow-md transition duration-150 ease-in-out flex flex-col items-center space-y-2`;
                button.setAttribute('onclick', `selectEmotion('${key}')`);
                button.innerHTML = `
                    <span class="emotion-icon">${emotion.name.split(' ')[1]}</span>
                    <span class="text-lg sm:text-xl">${emotion.name.split(' ')[0]}</span>
                `;
                emotionSelectionDiv.appendChild(button);
            });
        }

        /** é¸æ“‡æƒ…ç·’ (Phase 1 -> Phase 2) */
        function selectEmotion(key) {
            selectedEmotionKey = key;
            const emotion = emotions[key];

            selectedEmotionText.innerHTML = `ä½ é¸äº†ï¼š<span class="text-white p-2 rounded-lg ${emotion.color}">${emotion.name}</span>`;

            // æ¸²æŸ“è™•ç†æ–¹æ³•æŒ‰éˆ• (å¸¶æœ‰åˆå§‹ä½”ä½åœ–)
            renderCopingMethods(emotion);
            // ç•°æ­¥å•Ÿå‹• AI åœ–ç‰‡ç”Ÿæˆ
            generateCopingMethodImages(key);

            mainCard.classList.remove(...Object.values(emotions).map(e => e.bgClass));
            mainCard.classList.add(emotion.bgClass);
            
            showPhase(2);
        }

        /** ç•°æ­¥ç”Ÿæˆä¸¦è¼‰å…¥è™•ç†æ–¹æ³•åœ–ç‰‡ */
        async function generateCopingMethodImages(emotionKey) {
            const methods = emotions[emotionKey].methods;
            const buttons = copingSelectionDiv.querySelectorAll('.coping-btn');
            
            // å°‡æ‰€æœ‰æŒ‰éˆ•åˆ‡æ›åˆ°è¼‰å…¥ç‹€æ…‹
            buttons.forEach(btn => btn.classList.add('image-loading'));

            const generationPromises = methods.map((method, index) => {
                const imgElement = buttons[index].querySelector('img');

                return callImageAPI(method.aiPrompt, "1:1") // 1:1 æ¯”ä¾‹ç”¨æ–¼æ–¹æ³•åœ–ç¤º
                    .then(imageUrl => {
                        imgElement.src = imageUrl;
                        imgElement.classList.remove('image-loading'); // ç§»é™¤ loading æ¨£å¼
                        buttons[index].classList.remove('image-loading');
                    })
                    .catch(error => {
                        console.error(`Method ${method.text} image generation failed:`, error);
                        imgElement.src = 'https://placehold.co/100x100/EF4444/FFFFFF?text=åœ–å¤±æ•—';
                        buttons[index].classList.remove('image-loading');
                    });
            });

            // ç­‰å¾…æ‰€æœ‰åœ–ç‰‡è¼‰å…¥å®Œæˆ (æˆ–å¤±æ•—)
            await Promise.allSettled(generationPromises);
        }


        /** æ¸²æŸ“è™•ç†æƒ…ç·’çš„æ–¹æ³•æŒ‰éˆ• (åœ–æ–‡ä¸¦èŒ‚) */
        function renderCopingMethods(emotion) {
            copingSelectionDiv.innerHTML = '';
            // å°‡æ–¹æ³•éš¨æ©Ÿæ’åº
            const methods = emotion.methods.sort(() => Math.random() - 0.5);

            methods.forEach((method, index) => {
                const button = document.createElement('button');
                // åˆå§‹æ™‚åŠ å…¥ image-loading é¡åˆ¥
                button.className = `coping-btn ${emotion.color} text-white font-bold p-4 rounded-xl shadow-lg transition duration-150 ease-in-out flex flex-col items-center justify-center space-y-2 text-lg h-48 sm:h-56 image-loading`; 
                button.setAttribute('onclick', `selectCopingMethod('${method.text}')`);
                button.innerHTML = `
                    <img src="https://placehold.co/100x100/6B7280/FFFFFF?text=è¼‰å…¥ä¸­..." alt="${method.text}" class="rounded-lg border-2 border-white/50">
                    <span class="coping-icon">${method.icon}</span>
                    <span class="text-base sm:text-lg">${method.text}</span>
                `;
                copingSelectionDiv.appendChild(button);
            });
        }

        /** é¸æ“‡è™•ç†æƒ…ç·’çš„æ–¹æ³• (Phase 2 -> Phase 3) */
        function selectCopingMethod(methodText) {
            console.log(`å­©å­é¸æ“‡äº†è™•ç†æ–¹æ³•: ${methodText}`);
            
            // é€²å…¥å®Œæˆ/å›é¥‹éšæ®µ
            showPhase(3);
        }

        // --- æ‡‰ç”¨ç¨‹å¼å•Ÿå‹• ---
        // åˆå§‹è¼‰å…¥æ™‚é¡¯ç¤ºéšæ®µ 0
        document.addEventListener('DOMContentLoaded', resetApp);
    </script>
</body>
</html>